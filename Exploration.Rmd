---
title: "R Notebook"
output: html_notebook
---

## Introduction

For much of human existence, childbirth has been an extraordinarily risky event, often ending with the death of either the mother or baby. With the advent of modern medicine and technology, much of the world has seen a significant reduction in the infant mortality rate. While this is something to applaud, there is still much work to be done. Child development after birth is a crucial period during which many of the neurological and motor skills necessary for a full and healthy life ossify. Anything parents can do to increase the healthiness of the baby in this period could have substantial effects on a baby's health. One avenue that might have a positive impact is during the actual pregnancy. Some women engage in prenatal activities that may be risky and others engage in prenatal activities that might be salubrious. In this study, we seek to determine whether prenatal care has an effect on the health of a newborn.


```{r setup}
library(car)
library(ggplot2)
```


**Variable Descriptions:**

```{r load}
load("bwght_w203.RData")
desc
```


**Data Quality Assessment**
```{r}
# First we want to determine whether there are missing data. If there are, we will then want to determine whether
# there is a pattern to those missing data.

apply(data, 2, function(x) mean(is.na(x)))
```

The quick analysis shows that for many of the variables we are not missing any data, while there are several variables on which we are missing some data. The fact that the average number of drinks per night or cigarrettes per week variable has the most missing data could indicate that many mothers who did consume alcohol during their pregnacy refused to answer. This could potentially lead to nonresponse bias.  The omaps and fmaps variables have the exact same number of missing data. If this happens on the same observation, then we might have hospital bias. Some hospitals might not do these measurements. There is also a very high percentage of missing data from the same people on the smoking and drinking quesiton.


**Exploratory Analysis of each variable:**

Our exploratory analysis begins with an assessment of three possible dependent variables. Measurement of an infant's health immediately after birth can come in various forms and the dataset we have includes three different measurements: birthweight, the one minute agpar score, and the five minute agpar score. After we determine our preferred dependent variable, we will delve into the various independent variables available to measure level of prenatal care administered to mothers. Of course, it is reasonable to expect that during 9 months of gestation other variables besides those related to prenatal care may have an impact on the health of the infant, so we examine these variables and consider whether we need to control for them in isolating the effect of prenatal care.

We now look at the prospective dependent variables we might use to measure infant health. 

Birth Weight

```{r bwght}
ggplot(data = data, aes(x = data$bwght)) + geom_histogram(bins = 50, fill="dodgerblue1", colour = "black") +
  ggtitle('Birthweight of Infants') + xlab("Baby Birthweight (in grams)") +
  ylab('Count') + theme(axis.text.x = element_text(face = "bold"), axis.text.y = element_text(face = "bold"), plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
summary(data$bwght)

```

The birth weight variable is fairly normally distributied, even though it has a small negative skew. While it doesn't require any transformation, we could take log base 10 of birth weight, which when interpreted in a regression model would become a percent change in weight. This is a very good candidate for our dependent variable, because it is a continuous quantitative feature that is generally considered a good indicator of overall baby health. Moreover, there is no subjectivity to this measure: an infant is weighed and that measurement is recorded. Whereas in the agpar score - which we discuss below - the doctor makes diagnostic assessments that are subject to human error. If the data were collected from certain hospitals, then the agpar scores could be correlated with each other by including multiple assessments from the same doctor (other correlations would also creep in).

One- and Five- Minute APGAR Scores

```{r omaps}
omaps_summary <- summary(data$omaps)
fmaps_summary <- summary(data$fmaps)
combined_summary <- rbind(omaps_summary, fmaps_summary)
combined_summary
```

The one- and five- minute APGAR scores are a quick and easy scale that doctors can use to judge how healthy an infant looks one minute and five minute after it is born. It is generally used as a measure of the short-term health of the baby, helping doctors decide whether a baby will need immediate medical assistance. It is calculated by the doctor judging a baby on a scale of 0 to 2 across five different metrics (activity, pulse, grimace, appearance, respiration).

Therefore, this means that the APGAR scores are essentially an ordinal variable, since we cannot determine whether the difference between a 10 and 9 is the same as the distance between a 2 and a 1 but we do know that 10 is better than 9. As we can see from the summary table of both agpar scores, most of the scores are an 8 or above, which means that we don't have a lot of lower results to help us determine the effect of prenatal care in all cases. For these reasons and the reasons discussed above, we do not believe the APGAR scores are a good measure of infant health, and we therefore opt to use birthweight as our dependent variable in the models below.

## EDA of Independent Variables

### Key Variables Related to Prenatal Care
Length of Prenatal Care

```{r monpre}
ggplot(data = data, aes(x = data$monpre)) + geom_histogram(binwidth = 1, fill="dodgerblue1", colour = "black", origin = -0.5) +
  ggtitle('Month Prenatal Care Started') + xlab("Month") +
  ylab('Count') + theme(axis.text.x = element_text(face = "bold"), axis.text.y = element_text(face = "bold"), plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) + scale_x_continuous(breaks = c(0:10))
summary(data$monpre)

```

The monpre variable signifies the month of pregnancy at which prenatal care started, and is one of the key variables we expect to help us predict infant health. It ranges from zero to nine, which means there is probably some rounding as prenatal care is unlikely to begin at conception. This would make sense as we are dealing with a discrete variable. The histogram of monpre shows that the data has a heavy positive skew. There are large peaks at one and two, meaning that most women start prenatal care towards the middle of or end of the first trimester. Unfortunately, we do not know what type of prenatal care this variable maps to. When is prenatal care considered to have begun and what counts? We assume that prenatal care has begun with the first visit to a doctor or midwife, although it may truly begin with a phone call.

Number of Prenatal Visits 

```{r npvis}
ggplot(data = data, aes(x = data$npvis)) + geom_histogram(binwidth = 1, fill="dodgerblue1", colour = "black", origin = -0.5, bins = 30) +
  ggtitle('Number of Prenatal Care Visits') + xlab("Prenatal Care Visits") +
  ylab('Count') + theme(axis.text.x = element_text(face = "bold"), axis.text.y = element_text(face = "bold"), plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
summary(data$npvis)
```

The number of prenatal visits is another key metric we expect will have an effect on infant health. It has a strong positive skew, and we can see a massive peak at 12 visits. This could be because mothers with insurance that took part in this study were eligible for a certain number of prenatal visits (possibly 12) for free, leading to a lot of women making exactly that many visits. The question of who pays for these visits could have a confounding effect, because it is more likely for mothers to make more visits if they are free and they would probably make less visits if they aren't. 

Plotting the bivariate relationship between number of visits and the month at which prenatal care started (see below), we can see the possible outliers in the top right portion of the plot. These  mothers had around 30 visits, even though they started their prenatal care in the 8th month. It could be the case that these mothers were admitted into hospital for a long period for a specific health problem, but we should check if these  points have an influence on the regression line of our models. At the other end of the plot, we can see that data points in which mothers began prenatal care at the zeroeth month and yet also made 0 visits. We cannot be sure whether this is an accurate data point representing mothers who sought no prenatal care or whether this is an error and these points need to be excluded.

```{r}
ggplot(data = data, aes(x =data$monpre , y = data$npvis)) + geom_point() + geom_smooth(method = "loess") + geom_jitter(width = 0.2, height = 0.1) + ggtitle("Month Prenatal Care Began vs. Total Number of Prenatal Visits") + xlab("Month Prenatal Care Began") + ylab("Total Number of Prenatal Visits") + theme(axis.text.x = element_text(face = "bold"), axis.text.y = element_text(face = "bold"), plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) + scale_x_continuous(breaks = c(0:9))


```


Age Variables:

```{r mage}
hist(data$mage, breaks = 20)
summary(data$fage)
hist(data$fage, breaks = 40)
summary(data$fage)
```

The father and mother age variables both have fairly normal distributions around the 30-year mark, with the father age variable having a slight positive skew. This should mean that this dataset is fairly representative from an age perspective. 

Education variables

```{r meduc}
hist(data$meduc)
summary(data$meduc)
hist(data$feduc)
summary(data$feduc)
cor(data[complete.cases(data$feduc) & complete.cases(data$meduc),]$feduc, data[complete.cases(data$feduc) & complete.cases(data$meduc),]$meduc)

```

The mother and father education variables both show signs of graduation effect at the 12 (high school) and 16 (college) mark. Therefore, we can bucket this variable into high school, college, and further education (see Variable Transformation below).

Additionally, there is about 60% correlation between the education of the mother and father of each baby in the dataset, which aligns with the general notion that people marry others of the same education level.



Cigarettes

```{r cigs}
hist(data$cigs, breaks = 40)
hist(data$cigs[data$cigs > 0], breaks = 40)
nrow(data[data$cigs > 0,])/nrow(data)
summary(data$cigs)
```

The cigarettes variable has a peak at zero and a strong positive skew. Only about 14% of the data is of actual smokers, so we could get some skewed results. The distribution is very dispersed, with peaks at the 10, 20, 30, and 40 mark. This shows that people tended to round to these values, perhaps because they didn't know the exact number. It could also be the case that people tend do round down such values. This could lead to loss of important detail in the data, but the variable could still be used as an indicator of whether people are heavy, light or non-smokers in general (see variable transformation below).

Drinking

```{r drink}
hist(data$drink)
hist(data$drink[data$drink > 0], breaks = 40)
summary(data$drink)
```

In this dataset, there are only about 16 people that actually drank any alcohol during their pregnancy, and they make up only about 1% of the data. While it makes sense that respondents would stop drinking (or at least say they did) during their pregnancy, such a small amount of actual drinkers means this variable will not be helpful in explaining variances in infant health.

Baby Gender

```{r male}
table(data$male)
```

There are approximately the same amounts of male babies as female babies. This might be a useful control variable, in the case when one gender is heavier in general than the other. 
```{r}
summary(data[data$male ==1,]$bwght)
summary(data[data$male ==0,]$bwght)
```

Race

```{r mwhte}
nrow(data[data$mwhte == 1,])
nrow(data[data$mblck == 1,])
nrow(data[data$moth == 1,])
nrow(data[data$fwhte == 1,])
nrow(data[data$fblck == 1,])
nrow(data[data$foth == 1,])
table()
hist(data$mwhte)
summary(data$mwhte)
```

This study covers 1624 white, 109 black and 99 women of other races. The results for men is similar. While we don't expect race to have any effect on infant health, it is worth noting that the data is very skewed. 



**Variable transformation**

```{r}
data$npvismonth <- data$npvis/(10-data$monpre)

data$nonsmoker <- ifelse(data$cigs == 0, 1, 0)
data$smoker <- ifelse(data$cigs > 0, 1, 0)
data$lightsmoker <- ifelse(data$cigs > 0 & data$cigs <= 10, 1, 0)
data$occsmoker <- ifelse(data$cigs > 10 & data$cigs <= 20, 1, 0)
data$heavysmoker <- ifelse(data$cigs > 20, 1, 0)
data$drinker <- ifelse(data$drink >= 1, 1, 0)

data$mheduc <- ifelse(data$meduc <= 12, 1, 0)
data$fheduc <- ifelse(data$feduc <= 12, 1, 0)
data$mceduc <- ifelse(data$meduc > 12 & data$meduc <=16, 1, 0)
data$fceduc <- ifelse(data$feduc > 12 & data$feduc <=16, 1, 0)
data$mfureduc <- ifelse(data$meduc > 16, 1, 0)
data$ffureduc <- ifelse(data$feduc > 16, 1, 0)
```


**Different model testing**

```{r}
# Best model
model6 <- lm(bwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drink + male + fage + fwhte + fblck + foth + mwhte + mblck + moth, data=data)
model1 <- lm(bwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drink + male + fage, data=data)
model4 <- lm(lbwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drink + male + fage, data=data)
model5 <- lm(bwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drink + male + fage + fwhte + fblck + foth, data=data)


# Trying to use a drinker indicator variable
model2 <- lm(bwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drinker + male + fage, data=data)

# Using cigs instead of indicator variable
model3 <- lm(bwght ~ npvis + monpre + cigs + male + fage, data=data)

# With almost every variable
model7 <- lm(bwght ~ npvis + monpre + lightsmoker + occsmoker + heavysmoker + drink + male + fage + fwhte + fblck + foth + mwhte + mblck + moth + feduc, data=data)

# Stan model suggestions: should we use npvissq? It could be that number of visits has an effect that changes with the number of visits (parabolic relationship)
models1 = lm(bwght ~ monpre + npvis, data = data)
models2 = lm(bwght ~ monpre + npvis + npvissq, data = data)
AIC(models1)
AIC(models2)
summary(models1)
summary(models2)
coeftest(models1, vcov = vcovHC)
coeftest(models2, vcov = vcovHC)
```

**CLM Assumptions**

Normality of Errors
Zero mean conditional
Random Sample
Homoskedasticity



**Regression Table**

**Causality discussion**
we don't have anything to show us children that were born prematurely or later than nine months.In fact, such cases might be important because babies born prematurely tend to have smaller weight and face serious health risks. Therefore, the lack of this information might influence our conclusions. 

<<<<<<< HEAD
```{r scatterplotmatrix}
scatterplotMatrix(~ bwght + mage + meduc + monpre + npvis + fage + feduc + cigs + drink, data=data)
scatterplotMatrix(~ bwght + omaps + fmaps + male + mwhte + mblck + moth + fwhte + fblck + foth, data=data)
```

Bivariate Plots

```{r}
ggplot(data = data, aes(x = data$monpre, y = data$bwght)) + geom_point() + geom_smooth(method = "loess") # This strongly suggests that the month at which you start prenatal care has no impact on the birthweight of the baby.

ggplot(data = data, aes(x = data$npvis, y = data$bwght)) + geom_point() + geom_smooth(method = "loess") # serious outliers towards the lower left of the plot, but these will be outweighed by the many other variables whose x values are the same. There are scarly any data beyond 20 npvis. There seems to be a small positive effect to having over 5 visits.
```

Correlation Matrix
```{r}
cor_test <- as.data.frame(cor(data, use = "complete.obs"))
cor_test
```

Some high correlations:
Mage and meduc = 0.33
mage and fage = 0.689
feduc and meduc = 0.59
magesq & mage = 0.99
magesq & meduc  0.319
npvissq & npvis = 0.93


#First Model: Prenatal Care
```{r}
mod_key <- lm(bwght ~ monpre + npvis, data = data)
summary(mod_key)
plot(mod_key)
```

#Second Model: Prenatal Care + Helpful Covariates
```{r}
mod_cov <- lm(bwght ~ monpre + npvis + cigs + meduc + mage, data = data)
summary(mod_cov)
plot(mod_cov)
```

#Third Model: Prenatal Care + Helpful Covariates + Assumption Violating Covariates
```{r}
mod_cov_minus <- lm(bwght ~ monpre + npvis + cigs + feduc + fage + omaps + male, data = data)
summary(mod_cov_minus)
plot(mod_cov_minus)
```

#Model Selection Using Leaps
```{r}
install.packages("leaps")
library(leaps)
str(data)
regsubsets_out <- regsubsets(bwght ~ mage + meduc + monpre + npvis + fage + feduc + cigs + drink + male + mwhte + mblck + fwhte + fblck + npvissq, data = data, nbest = 1, nvmax = NULL, force.in = NULL, force.out = NULL, method = "exhaustive")
regsubsets_out
summary_out <- summary(regsubsets_out)
as.data.frame(summary_out$outmat)


plot(regsubsets_out, scale = "adjr2", main = "Adjusted R^2")
```
=======
**Conclusion**
>>>>>>> 22095f252bf00e33d2b896c4ef9ca6615deb1119
